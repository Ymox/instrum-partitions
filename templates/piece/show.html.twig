{% extends 'base.html.twig' %}

{% block title %}{{ piece.name }} | {{ parent() }}{% endblock %}

{% block body %}
	<h1>{{ piece.name }}
		{%- if piece.translation %}<br /><small>{{ piece.translation }}</small>{% endif %}</h1>
	
	<form action="{{ path('part_download') }}" class="table-responsive">
		<table class="table">
			<tbody>
				<tr>
					<th>{{ 'app.fields.id'|trans }}</th>
					<td>{{ piece.id }}</td>
					<th>{{ 'app.fields.piece.last_played'|trans }}</th>
					<td>{% if not piece.concerts.isEmpty -%}
							{% set link_class = '' %}
							{% if piece.concerts.count() > 1 -%}
						<div class="btn-group">
								{%- set link_class = ' class="btn btn-secondary"' %}
							{% endif -%}
						<a href="{{ path('concert_show', {'id': piece.concerts.first.id}) }}"{{ link_class|raw }}>{{ piece.concerts.first.name }}
							({{ piece.concerts.first.date|date('Y-m-d') }})</a>
							{% if piece.concerts.count() > 1 -%}
							</span>
							<a href="#" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<span class="sr-only">Toggle Dropdown</span>
							</a>
							<div class="dropdown-menu">
								{% for concert in piece.concerts[1:] %}
								<a class="dropdown-item" href="{{ path('concert_show', {'id': concert.id}) }}">{{ concert.name }}
									({{ concert.date|date('Y-m-d') }})</a>
								{% endfor %}
							</div>
						</div>
							{% endif -%}
						{%- else -%}
						<i>{{ 'app.piece.show.last_played.unknown'|trans }}</i>
						{%- endif -%}
					</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.composers'|trans }}</th>
					<td colspan="3">{{ piece.composers|join(', ') }}</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.arrangers'|trans }}</th>
					<td colspan="3">{{ piece.arrangers|join(', ') }}</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.publisher'|trans }} ({{ 'app.fields.piece.year'|trans }})</th>
					<td>{{ piece.publisher }}{% if piece.year %} ({{ piece.year }}){% endif %}</td>
					<th>{{ 'app.fields.piece.reference'|trans }}</th>
					<td>{{ piece.reference }}</td>
				</tr>
				</tr>
					<th>{{ 'app.fields.piece.instrumentation'|trans }}</th>
					<td{%- if piece.instrumentation %} title="{{ piece.instrumentation.note }}">
						{{ piece.instrumentation.name }}
						{%- else -%}>
						{%- endif -%}
					</td>
					<th>{{ 'app.fields.piece.status'|trans }}</th>
					<td>{{ piece.status }}
						{%- if piece.status in ['returned', 'lent'] %}
						{{ piece.lendings.first }}
						{%- endif %}
						{%- if not piece.missings.empty %}
						({% for missing in piece.missings -%}
						<span class="text-danger">{{ missing.voice }}</span>{% if not loop.last %}, {% endif -%}
						{% endfor -%}
						{% if not piece.lendings.empty and piece.lendings.first.ours %}
						— {% if is_granted('ROLE_ADMIN') %}<a href="{{ path('lending_show', { 'id': piece.lendings.first.id }) }}">{% endif %}
							{{- ('app.lending.ours.' ~ (piece.lendings.first.ours ? 'to' : 'by'))|trans ~ ' ' ~ piece.lendings.first.band }}
						{%- if is_granted('ROLE_ADMIN') %}</a>{% endif %}
						{%- endif %})
						{%- endif %}
					</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.note'|trans }}</th>
					<td colspan="3">{{ piece.note|nl2br }}</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.created_at'|trans }}</th>
					<td colspan="3">{{ piece.createdAt|date('Y-m-d à H:i:s') }}</td>
				</tr>
				{% if (not piece.parts.isEmpty) %}
				<tr>
					<td colspan="4"><h3>{{ 'app.fields.piece.parts'|trans }}
						{%- if is_granted('ROLE_DOWNLOAD') -%}<small class="pull-right"><input type="checkbox" id="CheckAll{{ piece.id }}" class="check-all" data-target=".check-all-{{ piece.id }}"/> <label for="CheckAll{{ piece.id }}">{{ 'global.action.check_all'|trans }}</label> <button type="submit" class="btn btn-sm btn-info" title="{{ 'app.file.download_selected'|trans }}"><i class="fa fa-download"></i></button></small>{% endif %}</h3></td>
				</tr>
				<tr>
					{% for order, part in piece.parts %}
					<td>{% if part.file and is_granted('ROLE_DOWNLOAD') %}<input type="checkbox" name="ids[]" value="{{ part.id }}" id="Part{{ part.id }}" class="check-all-{{ piece.id }}" data-parent="#CheckAll{{ piece.id }}" />
						<a href="{{ path('part_download', {'ids': [part.id]}) }}" class="btn btn-sm btn-outline-info" download="{{ piece.id ~ '-' ~ part.downloadName }}" title="{{ 'app.file.download'|trans }}"><i class="fa fa-download"></i></a>
						{%- endif %}
						<label for="Part{{ part.id }}">{{ part }}</label>
					</td>
						{% if (not loop.first and loop.index is divisible by(4)) %}
				</tr>
				<tr>
						{% endif %}
					{% endfor %}
					{% if (piece.parts|length is not divisible by(4)) %}
					<td colspan="{{ 4 - (piece.parts|length % 4) }}"></td>
					{% endif %}
				</tr>
				{% endif %}
				{% for i, movement in piece.movements %}
				<tr>
					<th colspan="4"><h2>{{ movement.name }}
						{%- if movement.translation %}<br /><small>{{ movement.translation }}</small>{% endif %}</h2></th>
				</tr>
				<tr>
					<th>{{ 'app.fields.id'|trans }}</th>
					<td>{{ movement.id }}</td>
					<th>{{ 'app.fields.piece.last_played'|trans }}</th>
					<td>{% if not movement.concerts.isEmpty -%}
						<a href="{{ path('concert_show', {'id': movement.concerts.first.id}) }}">{{ movement.concerts.first.name }}</a> ({{ movement.concerts.first.date|date('Y-m-d') }})
						{%- else -%}
						<i>{{ 'app.piece.show.last_played.unknown'|trans }}</i>
						{%- endif -%}
					</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.composers'|trans }}</th>
					<td colspan="3">{{ movement.composers|join(', ') }}</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.arrangers'|trans }}</th>
					<td colspan="3">{{ movement.arrangers|join(', ') }}</td>
				</tr>
				</tr>
					<th>{{ 'app.fields.piece.status'|trans }}</th>
					<td colspan="3">{{ movement.status }}
						{%- if movement.status in ['returned', 'lent'] %}
						{{ movement.lendings.first }}
						{%- endif %}
						{%- if not movement.missings.empty %}
						({% for missing in movement.missings -%}
						<span class="text-danger">{{ missing.voice }}</span>{% if not loop.last %}, {% endif -%}
						{% endfor -%}
						{% if not movement.lendings.empty and movement.lendings.first.ours %}
						— {% if is_granted('ROLE_ADMIN') %}<a href="{{ path('lending_show', { 'id': movement.lendings.first.id }) }}">{% endif %}
							{{- ('app.lending.ours.' ~ (movement.lendings.first.ours ? 'to' : 'by'))|trans ~ ' ' ~ movement.lendings.first.band }}
						{%- if is_granted('ROLE_ADMIN') %}</a>{% endif %}
						{%- endif %})
						{%- endif %}
					</td>
				</tr>
				<tr>
					<th>{{ 'app.fields.piece.note'|trans }}</th>
					<td colspan="3">{{ movement.note|nl2br }}</td>
				</tr>
				{% if (not movement.parts.isEmpty) %}
				<tr>
					<td colspan="4"><h3>{{ 'app.fields.piece.parts'|trans }}
						{%- if is_granted('ROLE_DOWNLOAD') -%}<small class="pull-right"><input type="checkbox" id="CheckAll{{ movement.id }}" class="check-all" data-target=".check-all-{{ movement.id }}" /> <label for="CheckAll{{ movement.id }}">{{ 'global.action.check_all'|trans }}</label> <button type="submit" class="btn btn-sm btn-info" title="{{ 'app.file.download_selected'|trans }}"><i class="fa fa-download"></i></button></small>{% endif %}</h3></td>	
				</tr>
				<tr>
					{% for order, part in movement.parts %}
					<td>{% if part.file and is_granted('ROLE_DOWNLOAD') %}<input type="checkbox" name="ids[]" value="{{ part.id }}" id="Part{{ part.id }}" class="check-all-{{ movement.id }}" data-parent="#CheckAll{{ movement.id }}" />
						<a href="{{ path('part_download', {'ids': [part.id]}) }}" class="btn btn-sm btn-outline-info" download="{{ piece.id ~ '-' ~ part.downloadName }}" title="{{ 'app.file.download'|trans }}"><i class="fa fa-floppy-o"></i></a>
						{%- endif %}
						<label for="Part{{ part.id }}">{{ part }}</label>
					</td>
						{% if (not loop.first and loop.index is divisible by(4)) %}
				</tr>
				<tr>
						{% endif %}
					{% endfor %}
					{% if (movement.parts|length is not divisible by(4)) %}
					<td colspan="{{ 4 - (movement.parts|length % 4) }}"></td>
					{% endif %}
				</tr>
				{% endif %}
				{% endfor %}
			</tbody>
		</table>
	</form>

	<ul class="list-inline float-right">
		<li class="list-inline-item">
			<a href="{{ path('piece_index') }}" class="btn btn-light"><i class="fa fa-list"></i></a>
		</li>
		<li class="list-inline-item">
			<a href="{{ path('piece_edit', { 'id': piece.id }) }}" class="btn btn-warning" class="btn btn-sm btn-warning"><i class="fa fa-pencil"></i></a>
		</li>
		<li class="list-inline-item">
			{{ form_start(delete_form) }}
				<button type="submit" class="btn btn-danger"><i class="fa fa-trash"></i></button>
			{{ form_end(delete_form) }}
		</li>
	</ul>
{% endblock %}

{% block javascripts %}
		<script src="{{ asset('js/check_all.js') }}"></script>
{% endblock %}
